#!/usr/bin/env ruby
require 'rubygems'
require 'net/http'
require 'uri'
require 'json'
require 'yaml'
require 'sinatra'

# Base URL of the PuppetDB database.  Do not include a trailing slash!
HOST_URI = 'http://<%= @puppetdb_host %>'
# Port number for the PuppetDB REST interface -- default is 8080 for clear, 8081 for SSL.
PORT = '<%= @puppetdb_port %>'

before do
    response['Content-Type'] = 'application/yaml'
end

def query_puppetdb(puppet_resource, query_params = nil)

    uri = URI.parse("#{HOST_URI}:#{PORT}/v3/#{puppet_resource}")
    uri.query = URI.encode_www_form(query_params) if query_params
    http = Net::HTTP.new(uri.host, uri.port)
    response = http.get("#{uri.path}?#{uri.query}", 'Accept' => 'application/json')

    return JSON.parse(response.body)
end

get '/' do

    rundeck_resources = {}

    resources = query_puppetdb('resources', 'query' => '["=", "type", "Class"],]')

    resources.each do |resource|
        host = resource['certname']
        title = resource['title']
        rundeck_resources[host] ||= {}
        rundeck_resources[host]['tags'] ||= []
        rundeck_resources[host]['tags'] << title
    end

    rundeck_resources.keys.sort.each do |k|
        rundeck_resources[k]['tags'] = rundeck_resources[k]['tags'].uniq.join(",")
        rundeck_resources[k]['hostname'] = k
    end

    facts = query_puppetdb('facts')

    facts.each do |fact|
        # skip hostname facts
        next if fact['name'] == 'hostname'

        host = fact['certname']
        name = fact['name']
        value = fact['value']
        if rundeck_resources.key?(host)
            rundeck_resources[host][name] = value.to_s
        end
    end

    rundeck_resources.to_yaml
end
